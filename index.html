<!DOCTYPE html>
<html lang="en-AU">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BudgetBud | Cloud Sync</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --primary: #2ecc71; --dark: #2c3e50; --danger: #e74c3c; --google-blue: #4285F4; --warning: #f1c40f;
            --bg: #f8f9fa; --card-bg: #ffffff; --text: #2c3e50; --border: #dfe6e9; --summary: #f1f2f6;
        }
        [data-theme="dark"] {
            --bg: #1a1a1a; --card-bg: #2d2d2d; --text: #f8f9fa; --border: #444; --summary: #3d3d3d;
        }
        body { font-family: -apple-system, system-ui, sans-serif; padding: 10px 10px 80px 10px; background: var(--bg); color: var(--text); line-height: 1.5; transition: background 0.3s; }
        .container { max-width: 500px; margin: auto; position: relative; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { color: var(--primary); text-align: center; margin-bottom: 5px; }
        .sync-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn { border: none; border-radius: 10px; padding: 12px; font-weight: bold; cursor: pointer; color: white; width: 100%; transition: opacity 0.2s; font-size: 14px; }
        .btn-sync { background: var(--google-blue); }
        .btn-main { background: var(--primary); margin-top: 10px; width: 100%; }
        .btn-del { background: var(--danger); padding: 5px 8px; width: auto; font-size: 11px; margin-left: 5px; }
        .btn-pay { background: var(--primary); padding: 5px 8px; width: auto; font-size: 11px; }
        .input-group { margin-bottom: 12px; }
        label { display: block; font-size: 0.8em; font-weight: 600; color: #7f8c8d; margin-bottom: 4px; }
        input, select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; box-sizing: border-box; font-size: 16px; background: var(--card-bg); color: var(--text); }
        .bill-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .bill-info { display: flex; flex-direction: column; flex-grow: 1; }
        .bill-type-tag { font-size: 0.7em; text-transform: uppercase; color: #95a5a6; font-weight: bold; }
        .forecast-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border); font-size: 0.9em; }
        .neg { background: rgba(231, 76, 60, 0.1); color: var(--danger); font-weight: bold; }
        .scroll-area { max-height: 400px; overflow-y: auto; background: var(--card-bg); border-radius: 10px; }
        #status { font-size: 0.7em; text-align: center; color: #95a5a6; margin-bottom: 15px; background: var(--summary); padding: 5px; border-radius: 5px; }
        .theme-toggle { position: absolute; top: 0; right: 0; background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 10px; color: var(--text); }
        .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card-bg); display: flex; justify-content: space-around; padding: 10px; border-top: 1px solid var(--border); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .tab-btn { background: none; border: none; color: #95a5a6; font-size: 0.7em; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
        .tab-btn.active { color: var(--primary); }
        .page { display: none; }
        .page.active { display: block; }
        .health-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; color: white; font-weight: bold; font-size: 0.8em; margin-bottom: 10px; }
        .week-block { border-left: 4px solid var(--primary); padding-left: 10px; margin-bottom: 15px; }
        .week-title { font-weight: bold; color: var(--primary); font-size: 0.9em; margin-bottom: 5px; }
        canvas { width: 100% !important; height: 300px !important; }

        /* Payday Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .modal { background: var(--card-bg); padding: 25px; border-radius: 16px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal h2 { margin-top: 0; color: var(--primary); }
        .modal p { color: var(--text); opacity: 0.8; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="container">
    <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">üåô</button>
    <h1>BudgetBud</h1>
    <div id="status">Status: Waiting for Google...</div>

    <div id="dashboard" class="page active">
        <div class="sync-bar">
            <button id="auth_btn" class="btn btn-sync" onclick="handleAuthClick()">Cloud Login</button>
            <button id="sync_btn" class="btn btn-sync" onclick="syncToDrive()" style="display:none; background:#34a853;">Save to Drive</button>
        </div>
        
        <div class="card" id="healthCard" style="text-align: center; display:none;">
            <div id="healthScore" class="health-badge"></div>
            <div id="healthText" style="font-size: 0.85em; opacity: 0.8;"></div>
        </div>

        <div class="card">
            <h2>Setup & Pay</h2>
            <div class="input-group"><label>Bank Balance ($)</label><input type="number" id="startBalance" step="0.01" onchange="renderBills()"></div>
            <div class="input-group"><label>Estimated Net Pay ($)</label><input type="number" id="payAmount" onchange="renderBills()"></div>
            <div class="input-group">
                <label>Pay Frequency</label>
                <select id="payFreq" onchange="renderBills()">
                    <option value="7">Weekly</option>
                    <option value="14" selected>Fortnightly</option>
                    <option value="30">Monthly</option>
                </select>
            </div>
            <div class="input-group"><label>Next Pay Date</label><input type="date" id="nextPayDate"></div>
        </div>

        <div class="card">
            <h3>Add Expense</h3>
            <select id="billType" class="input-group" onchange="toggleFreq()">
                <option value="recurring">Recurring Bill</option>
                <option value="once-off">Once-off Expense</option>
            </select>
            <input type="text" id="billName" placeholder="Name" class="input-group">
            <input type="number" id="billAmount" placeholder="Amount ($)" class="input-group">
            <div id="freqContainer"><select id="billFreq" class="input-group"><option value="7">Weekly</option><option value="14">Fortnightly</option><option value="30" selected>Monthly</option><option value="90">Quarterly</option></select></div>
            <input type="date" id="billDate" class="input-group">
            <button onclick="addBill()" class="btn btn-main">Add to Budget</button>
            <div id="billListUI"></div>
        </div>
    </div>

    <div id="graph" class="page">
        <div class="card">
            <h3>Balance Trend (90 Days)</h3>
            <canvas id="budgetChart"></canvas>
        </div>
    </div>

    <div id="weekly" class="page">
        <div class="card">
            <h3>Weekly Breakdown</h3>
            <div id="weeklyResults" class="scroll-area"></div>
        </div>
    </div>

    <div id="history" class="page">
        <div class="card">
            <h3>Payment History</h3>
            <input type="text" id="historySearch" placeholder="Search..." oninput="renderHistory()" class="input-group">
            <div id="historyStats" style="font-size: 0.8em; margin-bottom: 10px; color: var(--primary); font-weight: bold;"></div>
            <div id="historyListUI" class="scroll-area"></div>
            <button onclick="exportHistory()" class="btn btn-main" style="background:var(--dark)">Export CSV</button>
            <button onclick="clearHistory()" class="btn btn-del" style="margin-top:10px; width:100%;">Clear All</button>
        </div>
    </div>

    <nav class="tab-bar">
        <button class="tab-btn active" onclick="showPage('dashboard', this)"><span>üè†</span>Home</button>
        <button class="tab-btn" onclick="showPage('graph', this); updateChart();"><span>üìà</span>Graph</button>
        <button class="tab-btn" onclick="showPage('weekly', this); calculateForecast();"><span>üìÖ</span>Weekly</button>
        <button class="tab-btn" onclick="showPage('history', this)"><span>üìú</span>History</button>
    </nav>
</div>

<div id="paydayModal" class="modal-overlay" style="display:none;">
    <div class="modal">
        <h2>üí∞ It's Payday!</h2>
        <p>You expected <b>$<span id="modalExpectedPay"></span></b>.</p>
        <label>Verify Actual Amount Received:</label>
        <input type="number" id="modalActualPay" class="input-group" style="text-align:center; font-size:1.2em; font-weight:bold;">
        <button onclick="confirmPay()" class="btn btn-main" style="margin-top:10px;">Confirm & Add to Balance</button>
        <button onclick="closeModal()" class="btn btn-del" style="background:transparent; color:var(--text); margin-top:5px;">Not yet</button>
    </div>
</div>

<script>
    const CLIENT_ID = '209415722638-h0br52hmiektc9tbm9fqcfkb6uhuisaa.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    let tokenClient, accessToken = null, myChart = null;
    let bills = JSON.parse(localStorage.getItem('BudgetBud_bills')) || [];
    let historyLog = JSON.parse(localStorage.getItem('BudgetBud_history')) || [];

    function showPage(pageId, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        btn.classList.add('active');
    }

    function toggleTheme() {
        const target = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', target);
        localStorage.setItem('BudgetBud_theme', target);
        document.getElementById('themeBtn').innerText = target === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        if(myChart) updateChart();
    }

    const savedTheme = localStorage.getItem('BudgetBud_theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);

    window.onload = () => {
        document.getElementById('themeBtn').innerText = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        try {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES,
                callback: (resp) => {
                    accessToken = resp.access_token;
                    document.getElementById('auth_btn').innerText = "Logged In";
                    document.getElementById('sync_btn').style.display = "block";
                    document.getElementById('status').innerText = "Status: Cloud Connected";
                    pullFromDrive();
                },
            });
        } catch (e) { console.error(e); }
        loadLocal();
        checkPayday(); // Check if today is payday
    };

    function checkPayday() {
        const pDateStr = document.getElementById('nextPayDate').value;
        if (!pDateStr) return;
        
        const today = new Date();
        today.setHours(0,0,0,0);
        const pDate = new Date(pDateStr);
        pDate.setHours(0,0,0,0);

        if (today >= pDate) {
            const expected = document.getElementById('payAmount').value;
            document.getElementById('modalExpectedPay').innerText = expected;
            document.getElementById('modalActualPay').value = expected;
            document.getElementById('paydayModal').style.display = 'flex';
        }
    }

    function confirmPay() {
        const actual = parseFloat(document.getElementById('modalActualPay').value);
        if (isNaN(actual)) return alert("Enter valid amount");

        // 1. Update Balance
        let currentBal = parseFloat(document.getElementById('startBalance').value) || 0;
        currentBal += actual;
        document.getElementById('startBalance').value = currentBal.toFixed(2);

        // 2. Advance Pay Date
        const pDate = new Date(document.getElementById('nextPayDate').value);
        const freq = parseInt(document.getElementById('payFreq').value);
        pDate.setDate(pDate.getDate() + freq);
        document.getElementById('nextPayDate').value = pDate.toISOString().split('T')[0];

        // 3. Log to History
        historyLog.unshift({ name: "Income (Pay)", amount: actual, type: "Income", paidDate: new Date().toLocaleDateString('en-AU') });
        
        saveLocal();
        renderHistory();
        renderBills(); // Re-calc health
        document.getElementById('paydayModal').style.display = 'none';
        alert(`$${actual} added to balance! Next pay set to ${pDate.toLocaleDateString('en-AU')}`);
    }

    function closeModal() {
        document.getElementById('paydayModal').style.display = 'none';
    }

    /* EXISTING FUNCTIONS BELOW (No Changes needed to logic, just references) */

    function updateHealthScore(monthlyTotal) {
        const payAmount = parseFloat(document.getElementById('payAmount').value) || 0;
        const payFreq = parseInt(document.getElementById('payFreq').value) || 14;
        const healthCard = document.getElementById('healthCard');
        const healthScore = document.getElementById('healthScore');
        const healthText = document.getElementById('healthText');

        if (payAmount <= 0) { healthCard.style.display = "none"; return; }
        healthCard.style.display = "block";

        // Calculate Monthly Income based on frequency
        let monthlyIncome = 0;
        if (payFreq === 7) monthlyIncome = payAmount * 4.33;
        else if (payFreq === 14) monthlyIncome = payAmount * 2.16;
        else if (payFreq === 30) monthlyIncome = payAmount;

        const ratio = (monthlyTotal / monthlyIncome) * 100;

        let grade = "F", color = "#e74c3c", tip = "Bills are consuming your income.";
        if (ratio < 30) { grade = "Score: A"; color = "#2ecc71"; tip = "Excellent overhead!"; }
        else if (ratio < 50) { grade = "Score: B"; color = "#3498db"; tip = "Solid budget balance."; }
        else if (ratio < 70) { grade = "Score: C"; color = "#f1c40f"; tip = "Tight overhead, watch spending."; }
        else if (ratio < 90) { grade = "Score: D"; color = "#e67e22"; tip = "High bills relative to pay."; }

        healthScore.innerText = grade;
        healthScore.style.backgroundColor = color;
        healthText.innerText = `${ratio.toFixed(0)}% of income goes to recurring bills. ${tip}`;
    }

    function renderBills() {
        const ui = document.getElementById('billListUI');
        ui.innerHTML = bills.length ? '<h4 style="margin:15px 0 5px;">Upcoming</h4>' : '';
        let monthlyTotal = 0;
        bills.forEach((b, i) => {
            const div = document.createElement('div'); div.className = 'bill-item';
            div.innerHTML = `<div class="bill-info"><span class="bill-type-tag">${b.type}</span><span><b>${b.name}</b> ($${b.amount})</span></div><button onclick="markAsPaid(${i})" class="btn btn-pay">Paid</button><button onclick="deleteBill(${i})" class="btn btn-del">X</button>`;
            ui.appendChild(div);
            if (b.type === 'recurring') {
                if (b.freq === 7) monthlyTotal += (b.amount * 4.33);
                else if (b.freq === 14) monthlyTotal += (b.amount * 2.16);
                else if (b.freq === 30) monthlyTotal += b.amount;
                else if (b.freq === 90) monthlyTotal += (b.amount / 3);
            }
        });
        updateHealthScore(monthlyTotal);
    }

    function updateChart() {
        const ctx = document.getElementById('budgetChart').getContext('2d');
        let bal = parseFloat(document.getElementById('startBalance').value) || 0;
        const pay = parseFloat(document.getElementById('payAmount').value) || 0;
        const payFreq = parseInt(document.getElementById('payFreq').value) || 14;
        const pDate = new Date(document.getElementById('nextPayDate').value);
        if (isNaN(pDate.getTime())) return;
        let labels = [], data = [], current = new Date();
        let tempBills = JSON.parse(JSON.stringify(bills)).map(b => { b.nextDate = new Date(b.nextDate); return b; });
        for (let i = 0; i < 90; i++) {
            const diffDays = Math.floor((current - pDate) / (1000 * 60 * 60 * 24));
            if (diffDays >= 0 && diffDays % payFreq === 0) bal += pay;
            tempBills.forEach(b => { if (current.toDateString() === b.nextDate.toDateString()) { bal -= b.amount; if (b.freq > 0) b.nextDate.setDate(b.nextDate.getDate() + b.freq); else b.nextDate.setDate(b.nextDate.getDate() + 999); } });
            labels.push(current.toLocaleDateString('en-AU', {day:'2-digit', month:'short'})); data.push(bal); current.setDate(current.getDate() + 1);
        }
        if (myChart) myChart.destroy();
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        myChart = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: [{ label: 'Balance', data: data, borderColor: '#2ecc71', pointRadius: 0, fill: false }, { label: 'Zero', data: new Array(90).fill(0), borderColor: '#e74c3c', borderDash: [5, 5], pointRadius: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { grid: { color: isDark ? '#444' : '#eee' } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
        });
    }

    /* UTILS */
    function toggleFreq() { document.getElementById('freqContainer').style.display = document.getElementById('billType').value === 'once-off' ? 'none' : 'block'; }
    function addBill() {
        const name = document.getElementById('billName').value, amount = parseFloat(document.getElementById('billAmount').value);
        const type = document.getElementById('billType').value, freq = type === 'once-off' ? 0 : parseInt(document.getElementById('billFreq').value), date = document.getElementById('billDate').value;
        if (!name || isNaN(amount) || !date) return alert("Missing info");
        bills.push({ name, amount, type, freq, nextDate: date });
        saveLocal(); renderBills();
        document.getElementById('billName').value = ''; document.getElementById('billAmount').value = '';
    }
    function markAsPaid(index) {
        const item = bills[index]; historyLog.unshift({ ...item, paidDate: new Date().toLocaleDateString('en-AU') });
        if (item.type === 'once-off') bills.splice(index, 1);
        else { let d = new Date(item.nextDate); d.setDate(d.getDate() + item.freq); bills[index].nextDate = d.toISOString().split('T')[0]; }
        saveLocal(); renderBills(); renderHistory();
    }
    function renderHistory() {
        const ui = document.getElementById('historyListUI'), stats = document.getElementById('historyStats'), s = document.getElementById('historySearch').value.toLowerCase();
        const f = historyLog.filter(h => h.name.toLowerCase().includes(s));
        stats.innerHTML = f.length ? `Total: $${f.reduce((sum, x) => sum + x.amount, 0).toFixed(2)}` : "";
        ui.innerHTML = f.length ? '' : '<p style="text-align:center;">No records.</p>';
        f.forEach(h => { const div = document.createElement('div'); div.className = 'bill-item'; div.innerHTML = `<div class="bill-info"><span class="bill-type-tag">Paid ${h.paidDate}</span><span>${h.name} ($${h.amount})</span></div>`; ui.appendChild(div); });
    }
    function calculateForecast() {
        saveLocal(); let bal = parseFloat(document.getElementById('startBalance').value) || 0, pay = parseFloat(document.getElementById('payAmount').value) || 0, payFreq = parseInt(document.getElementById('payFreq').value) || 14, pDate = new Date(document.getElementById('nextPayDate').value), res = document.getElementById('weeklyResults');
        res.innerHTML = ""; if (isNaN(pDate.getTime())) return;
        let curr = new Date(), temp = JSON.parse(JSON.stringify(bills)).map(b => { b.nextDate = new Date(b.nextDate); return b; });
        for (let w = 0; w < 12; w++) {
            let weekHTML = `<div class="week-block"><div class="week-title">Week ${w+1}</div>`;
            for (let d = 0; d < 7; d++) {
                let n = ""; const diff = Math.floor((curr - pDate) / (1000 * 60 * 60 * 24));
                if (diff >= 0 && diff % payFreq === 0) { bal += pay; n = `<b>+[Pay]</b>`; }
                temp.forEach(b => { if (curr.toDateString() === b.nextDate.toDateString()) { bal -= b.amount; n += ` [${b.name}]`; if (b.freq > 0) b.nextDate.setDate(b.nextDate.getDate() + b.freq); else b.nextDate.setDate(b.nextDate.getDate() + 999); } });
                if (n) weekHTML += `<div class="forecast-row"><span>${curr.toLocaleDateString('en-AU', {day:'2-digit', month:'short'})}</span> <small>${n}</small> <span>$${bal.toFixed(0)}</span></div>`;
                curr.setDate(curr.getDate() + 1);
            }
            res.innerHTML += weekHTML + `<div style="text-align:right; font-size:0.8em; padding:5px;">End: $${bal.toFixed(0)}</div></div>`;
        }
    }
    function loadLocal() {
        document.getElementById('startBalance').value = localStorage.getItem('BudgetBud_startBal') || '';
        document.getElementById('payAmount').value = localStorage.getItem('BudgetBud_payAmt') || '';
        document.getElementById('nextPayDate').value = localStorage.getItem('BudgetBud_payDate') || '';
        document.getElementById('payFreq').value = localStorage.getItem('BudgetBud_payFreq') || '14';
        renderBills(); renderHistory();
    }
    function saveLocal() {
        localStorage.setItem('BudgetBud_bills', JSON.stringify(bills)); localStorage.setItem('BudgetBud_history', JSON.stringify(historyLog));
        localStorage.setItem('BudgetBud_startBal', document.getElementById('startBalance').value); 
        localStorage.setItem('BudgetBud_payAmt', document.getElementById('payAmount').value); 
        localStorage.setItem('BudgetBud_payDate', document.getElementById('nextPayDate').value);
        localStorage.setItem('BudgetBud_payFreq', document.getElementById('payFreq').value);
    }
    function deleteBill(index) { bills.splice(index, 1); saveLocal(); renderBills(); }
    function clearHistory() { if(confirm("Clear history?")) { historyLog = []; saveLocal(); renderHistory(); } }
    function exportHistory() {
        let csv = "Name,Amount,Type,Paid Date\n"; historyLog.forEach(h => { csv += `"${h.name}",${h.amount},"${h.type}","${h.paidDate}"\n`; });
        const blob = new Blob([csv], { type: 'text/csv' }), url = window.URL.createObjectURL(blob), a = document.createElement('a');
        a.href = url; a.download = `History_${new Date().toLocaleDateString('en-AU')}.csv`; a.click();
    }
    function handleAuthClick() { tokenClient.requestAccessToken({prompt: 'consent'}); }
    async function syncToDrive() {
        if (!accessToken) return;
        const content = { bills, historyLog, balance: document.getElementById('startBalance').value, pay: document.getElementById('payAmount').value, payDate: document.getElementById('nextPayDate').value, payFreq: document.getElementById('payFreq').value };
        try {
            const searchRes = await fetch(`https://www.googleapis.com/drive/v3/files?q=name='budgetbud_data.json' and trashed=false`, { headers: { 'Authorization': `Bearer ${accessToken}` } });
            const searchData = await searchRes.json();
            let url = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', method = 'POST';
            if (searchData.files && searchData.files.length > 0) { url = `https://www.googleapis.com/upload/drive/v3/files/${searchData.files[0].id}?uploadType=multipart`; method = 'PATCH'; }
            const formData = new FormData();
            formData.append("metadata", new Blob([JSON.stringify({ name: 'budgetbud_data.json', mimeType: 'application/json' })], { type: 'application/json' }));
            formData.append("file", new Blob([JSON.stringify(content)], { type: 'application/json' }));
            await fetch(url, { method: method, headers: { 'Authorization': `Bearer ${accessToken}` }, body: formData });
            document.getElementById('status').innerText = "Status: Saved to Cloud";
        } catch (e) { console.error(e); }
    }
    async function pullFromDrive() {
        try {
            const searchRes = await fetch(`https://www.googleapis.com/drive/v3/files?q=name='budgetbud_data.json' and trashed=false&fields=files(id)`, { headers: { 'Authorization': `Bearer ${accessToken}` } });
            const searchData = await searchRes.json();
            if (searchData.files && searchData.files.length > 0) {
                const fileRes = await fetch(`https://www.googleapis.com/drive/v3/files/${searchData.files[0].id}?alt=media`, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                const cloudData = await fileRes.json();
                bills = cloudData.bills || []; historyLog = cloudData.historyLog || [];
                document.getElementById('startBalance').value = cloudData.balance || '';
                document.getElementById('payAmount').value = cloudData.pay || '';
                document.getElementById('nextPayDate').value = cloudData.payDate || '';
                document.getElementById('payFreq').value = cloudData.payFreq || '14';
                saveLocal(); renderBills(); renderHistory();
                document.getElementById('status').innerText = "Status: Cloud Data Loaded";
                checkPayday(); // Re-check payday after cloud load
            }
        } catch (e) { console.error(e); }
    }
</script>
</body>
</html>
